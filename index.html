<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CMLB Recipe Catalog</title>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,600;1,400&family=Crimson+Text:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #0f0c08;
      --surface: #1c1510;
      --surface2: #251c14;
      --border: #3a2a18;
      --gold: #c8860a;
      --gold-light: #f5dfa0;
      --text: #e8d5b0;
      --text-muted: #8a6940;
      --text-dim: #4a3520;
      --red: #c0392b;
      --green: #27ae60;
      --blue: #2980b9;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { background: var(--bg); color: var(--text); font-family: 'Crimson Text', Georgia, serif; font-size: 18px; min-height: 100vh; }
    body::before { content:''; position:fixed; inset:0; background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.04'/%3E%3C/svg%3E"); pointer-events:none; z-index:9999; opacity:0.4; }

    /* Login screen */
    .login-screen { display:flex; align-items:center; justify-content:center; height:100vh; }
    .login-card { background:var(--surface); border:1px solid var(--border); border-radius:16px; padding:48px; text-align:center; max-width:400px; width:100%; }
    .login-card h1 { font-family:'Playfair Display',serif; font-style:italic; font-weight:400; font-size:32px; color:var(--gold-light); margin-bottom:8px; }
    .login-card p { color:var(--text-muted); font-size:16px; margin-bottom:32px; }
    .google-btn { display:flex; align-items:center; justify-content:center; gap:12px; background:#fff; color:#333; border:none; border-radius:8px; padding:14px 24px; font-family:'Crimson Text',serif; font-size:17px; cursor:pointer; width:100%; transition:background 0.2s; }
    .google-btn:hover { background:#f5f5f5; }
    .google-btn svg { width:20px; height:20px; flex-shrink:0; }
    .login-error { color:#e07060; font-size:14px; margin-top:16px; }

    /* App layout */
    .app { display:flex; height:100vh; overflow:hidden; }

    /* Sidebar */
    .sidebar { width:280px; flex-shrink:0; background:var(--surface); border-right:1px solid var(--border); display:flex; flex-direction:column; overflow:hidden; }
    .sidebar-header { padding:20px 18px 14px; border-bottom:1px solid var(--border); }
    .sidebar-header h1 { font-family:'Playfair Display',serif; font-size:18px; font-weight:400; font-style:italic; color:var(--gold-light); }
    .user-row { display:flex; align-items:center; gap:8px; margin-top:8px; }
    .user-avatar { width:24px; height:24px; border-radius:50%; }
    .user-name { font-size:13px; color:var(--text-muted); flex:1; }
    .signout-btn { background:none; border:none; color:var(--text-dim); font-size:12px; cursor:pointer; font-family:'Crimson Text',serif; }
    .signout-btn:hover { color:var(--red); }
    .add-btn { margin:10px 16px; background:var(--gold); border:none; color:#0f0c08; padding:9px 14px; border-radius:8px; font-family:'Playfair Display',serif; font-size:14px; font-style:italic; cursor:pointer; transition:background 0.2s; }
    .add-btn:hover { background:var(--gold-light); }
    .chat-btn { margin:0 16px 10px; background:var(--surface2); border:1px solid var(--border); color:var(--text-muted); padding:9px 14px; border-radius:8px; font-family:'Playfair Display',serif; font-size:14px; font-style:italic; cursor:pointer; transition:all 0.2s; }
    .chat-btn:hover { border-color:var(--gold); color:var(--gold); }
    .search-wrap { padding:10px 16px; border-bottom:1px solid var(--border); }
    .search-wrap input { width:100%; background:var(--surface2); border:1px solid var(--border); border-radius:6px; color:var(--text); padding:7px 10px; font-family:'Crimson Text',serif; font-size:15px; outline:none; transition:border-color 0.2s; }
    .search-wrap input:focus { border-color:var(--gold); }
    .search-wrap input::placeholder { color:var(--text-dim); }
    .filters { padding:8px 16px; border-bottom:1px solid var(--border); display:flex; flex-wrap:wrap; gap:4px; }
    .filter-btn { background:transparent; border:1px solid var(--border); color:var(--text-muted); padding:3px 9px; border-radius:20px; font-family:'Crimson Text',serif; font-size:12px; cursor:pointer; transition:all 0.2s; }
    .filter-btn:hover { border-color:var(--gold); color:var(--gold); }
    .filter-btn.active { background:var(--gold); border-color:var(--gold); color:#0f0c08; font-weight:600; }
    .recipe-list { flex:1; overflow-y:auto; padding:6px 0; }
    .recipe-list::-webkit-scrollbar { width:3px; }
    .recipe-list::-webkit-scrollbar-thumb { background:var(--border); border-radius:2px; }
    .recipe-item { padding:10px 16px; cursor:pointer; border-left:3px solid transparent; transition:all 0.15s; border-bottom:1px solid var(--surface2); }
    .recipe-item:hover { background:var(--surface2); border-left-color:var(--border); }
    .recipe-item.active { background:var(--surface2); border-left-color:var(--gold); }
    .recipe-item-title { font-family:'Playfair Display',serif; font-size:13px; color:var(--gold-light); line-height:1.3; margin-bottom:3px; }
    .recipe-item-meta { display:flex; align-items:center; gap:6px; flex-wrap:wrap; }
    .stars { color:var(--gold); font-size:10px; }
    .tag { font-size:10px; padding:1px 6px; border-radius:10px; background:var(--surface); color:var(--text-muted); border:1px solid var(--border); }
    .fav-badge { color:var(--red); font-size:11px; }
    .cook-time { font-size:10px; color:var(--text-muted); }

    /* Main panel */
    .main { flex:1; overflow-y:auto; padding:36px 44px; }
    .main::-webkit-scrollbar { width:3px; }
    .main::-webkit-scrollbar-thumb { background:var(--border); border-radius:2px; }
    .empty-state { display:flex; flex-direction:column; align-items:center; justify-content:center; height:100%; color:var(--text-dim); text-align:center; gap:14px; }
    .empty-state .icon { font-size:52px; }
    .empty-state h2 { font-family:'Playfair Display',serif; font-style:italic; font-weight:400; font-size:22px; color:var(--text-muted); }

    /* Recipe detail */
    .recipe-title { font-family:'Playfair Display',serif; font-size:30px; font-weight:400; font-style:italic; color:var(--gold-light); line-height:1.2; margin-bottom:14px; }
    .recipe-meta-row { display:flex; align-items:center; gap:10px; flex-wrap:wrap; margin-bottom:22px; padding-bottom:22px; border-bottom:1px solid var(--border); }
    .meta-pill { background:var(--surface2); border:1px solid var(--border); color:var(--text-muted); font-size:12px; padding:3px 12px; border-radius:20px; }
    .meta-pill.category { color:var(--gold); border-color:var(--gold); }
    .big-stars { color:var(--gold); font-size:18px; letter-spacing:2px; }
    .notes-block { background:var(--surface2); border-left:3px solid var(--gold); padding:12px 16px; border-radius:0 8px 8px 0; margin-bottom:28px; font-style:italic; color:var(--text-muted); font-size:16px; line-height:1.6; }
    .component { margin-bottom:32px; }
    .component-title { font-family:'Playfair Display',serif; font-size:18px; font-weight:600; color:var(--gold-light); margin-bottom:14px; padding-bottom:8px; border-bottom:1px solid var(--border); }
    .component-grid { display:grid; grid-template-columns:1fr 1.6fr; gap:20px; }
    .col-label { font-size:10px; letter-spacing:0.15em; text-transform:uppercase; color:var(--text-muted); margin-bottom:8px; }
    .ingredient-item { display:flex; align-items:baseline; gap:8px; padding:6px 0; border-bottom:1px solid var(--surface2); font-size:15px; }
    .ingredient-item::before { content:'¬∑'; color:var(--gold); flex-shrink:0; }
    .step-item { display:flex; gap:10px; padding:7px 0; border-bottom:1px solid var(--surface2); font-size:15px; color:var(--text-muted); line-height:1.6; }
    .step-num { color:var(--gold); font-family:'Playfair Display',serif; font-size:16px; flex-shrink:0; width:18px; }
    .action-row { display:flex; gap:8px; margin-bottom:20px; }
    .btn { padding:7px 18px; border-radius:6px; font-family:'Crimson Text',serif; font-size:15px; cursor:pointer; border:1px solid var(--border); background:var(--surface2); color:var(--text-muted); transition:all 0.2s; }
    .btn:hover { border-color:var(--gold); color:var(--gold); }
    .btn-danger:hover { border-color:var(--red); color:var(--red); }

    /* Form */
    .form-wrap { max-width:700px; }
    .form-title { font-family:'Playfair Display',serif; font-size:26px; font-style:italic; font-weight:400; color:var(--gold-light); margin-bottom:24px; }
    .form-grid { display:grid; grid-template-columns:1fr 1fr; gap:14px; }
    .form-group { display:flex; flex-direction:column; gap:5px; margin-bottom:14px; }
    .form-group label { font-size:10px; letter-spacing:0.15em; text-transform:uppercase; color:var(--text-muted); }
    .form-control { background:var(--surface2); border:1px solid var(--border); border-radius:6px; color:var(--text); padding:9px 11px; font-family:'Crimson Text',serif; font-size:16px; outline:none; transition:border-color 0.2s; width:100%; }
    .form-control:focus { border-color:var(--gold); }
    select.form-control option { background:var(--surface2); }
    textarea.form-control { resize:vertical; min-height:70px; }
    .star-select { display:flex; gap:6px; }
    .star-select span { font-size:24px; cursor:pointer; color:var(--text-dim); transition:color 0.15s; user-select:none; }
    .star-select span.lit { color:var(--gold); }
    .checkbox-row { display:flex; align-items:center; gap:8px; cursor:pointer; }
    .checkbox-row input { width:16px; height:16px; accent-color:var(--gold); cursor:pointer; }
    .comp-block { background:var(--surface2); border:1px solid var(--border); border-radius:8px; padding:16px; margin-bottom:12px; }
    .comp-block-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:12px; }
    .comp-name-input { background:transparent; border:none; border-bottom:1px solid var(--border); color:var(--gold-light); font-family:'Playfair Display',serif; font-size:15px; outline:none; width:85%; padding:2px 0; }
    .comp-name-input:focus { border-bottom-color:var(--gold); }
    .icon-btn { background:none; border:none; color:var(--text-dim); cursor:pointer; font-size:16px; padding:2px 5px; }
    .icon-btn:hover { color:var(--red); }
    .list-rows { display:flex; flex-direction:column; gap:5px; margin-bottom:5px; }
    .list-row { display:flex; gap:6px; align-items:center; }
    .list-row input { flex:1; background:var(--bg); border:1px solid var(--border); border-radius:6px; color:var(--text); padding:6px 9px; font-family:'Crimson Text',serif; font-size:14px; outline:none; }
    .list-row input:focus { border-color:var(--gold); }
    .add-row-btn { background:none; border:1px dashed var(--border); border-radius:6px; color:var(--text-muted); cursor:pointer; padding:5px 10px; font-size:12px; font-family:'Crimson Text',serif; transition:all 0.2s; }
    .add-row-btn:hover { border-color:var(--gold); color:var(--gold); }
    .add-comp-btn { background:none; border:1px dashed var(--border); border-radius:8px; color:var(--text-muted); cursor:pointer; padding:10px; font-size:14px; font-family:'Crimson Text',serif; width:100%; transition:all 0.2s; margin-bottom:20px; }
    .add-comp-btn:hover { border-color:var(--gold); color:var(--gold); }
    .form-actions { display:flex; gap:10px; margin-top:6px; }
    .btn-save { background:var(--gold); border:none; color:#0f0c08; padding:11px 26px; border-radius:8px; font-family:'Playfair Display',serif; font-size:15px; font-style:italic; cursor:pointer; transition:background 0.2s; }
    .btn-save:hover { background:var(--gold-light); }
    .btn-save:disabled { opacity:0.5; cursor:not-allowed; }
    .btn-cancel { background:none; border:1px solid var(--border); color:var(--text-muted); padding:11px 18px; border-radius:8px; font-family:'Crimson Text',serif; font-size:15px; cursor:pointer; }
    .btn-cancel:hover { border-color:var(--text-muted); color:var(--text); }
    .success-msg { background:#0a2a14; border:1px solid #1e6b3a; color:#5dbf85; padding:10px 14px; border-radius:8px; font-size:14px; margin-bottom:16px; }
    .error-msg { background:#2a0a08; border:1px solid #6b1a14; color:#e07060; padding:10px 14px; border-radius:8px; font-size:14px; margin-bottom:16px; }

    /* Chat panel */
    .chat-panel { width:360px; flex-shrink:0; background:var(--surface); border-left:1px solid var(--border); display:flex; flex-direction:column; overflow:hidden; }
    .chat-header { padding:16px 18px; border-bottom:1px solid var(--border); display:flex; justify-content:space-between; align-items:center; }
    .chat-header h3 { font-family:'Playfair Display',serif; font-style:italic; font-weight:400; font-size:17px; color:var(--gold-light); }
    .close-chat-btn { background:none; border:none; color:var(--text-dim); cursor:pointer; font-size:18px; }
    .close-chat-btn:hover { color:var(--text-muted); }
    .chat-messages { flex:1; overflow-y:auto; padding:16px; display:flex; flex-direction:column; gap:12px; }
    .chat-messages::-webkit-scrollbar { width:3px; }
    .chat-messages::-webkit-scrollbar-thumb { background:var(--border); border-radius:2px; }
    .chat-msg { max-width:90%; padding:10px 14px; border-radius:10px; font-size:15px; line-height:1.55; }
    .chat-msg.user { background:var(--gold); color:#0f0c08; align-self:flex-end; border-radius:10px 10px 2px 10px; }
    .chat-msg.assistant { background:var(--surface2); color:var(--text); align-self:flex-start; border-radius:10px 10px 10px 2px; border:1px solid var(--border); }
    .chat-msg.assistant.thinking { color:var(--text-muted); font-style:italic; }
    .chat-input-row { padding:12px 14px; border-top:1px solid var(--border); display:flex; gap:8px; }
    .chat-input { flex:1; background:var(--surface2); border:1px solid var(--border); border-radius:8px; color:var(--text); padding:9px 12px; font-family:'Crimson Text',serif; font-size:15px; outline:none; resize:none; max-height:100px; }
    .chat-input:focus { border-color:var(--gold); }
    .chat-send-btn { background:var(--gold); border:none; color:#0f0c08; padding:9px 14px; border-radius:8px; cursor:pointer; font-size:16px; transition:background 0.2s; }
    .chat-send-btn:hover { background:var(--gold-light); }
    .chat-send-btn:disabled { opacity:0.4; cursor:not-allowed; }
    .save-recipe-btn { margin-top:8px; background:var(--surface); border:1px solid var(--gold); color:var(--gold); padding:6px 14px; border-radius:6px; font-family:'Crimson Text',serif; font-size:13px; cursor:pointer; transition:all 0.2s; width:100%; }
    .save-recipe-btn:hover { background:var(--gold); color:#0f0c08; }

    @keyframes fadeIn { from{opacity:0;transform:translateY(8px)} to{opacity:1;transform:translateY(0)} }
    .fade-in { animation:fadeIn 0.3s ease forwards; }
    .loading-screen { display:flex; align-items:center; justify-content:center; height:100vh; font-family:'Playfair Display',serif; font-style:italic; font-size:20px; color:var(--text-muted); }
  </style>
</head>
<body>
<div id="root"><div class="loading-screen">Loading...</div></div>

<!-- Firebase -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged }
  from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc, query, orderBy }
  from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDtszGE-y56VKC0vtXUdRY12Iujuh_lJN8",
  authDomain: "cmlb-recipes.firebaseapp.com",
  projectId: "cmlb-recipes",
  storageBucket: "cmlb-recipes.firebasestorage.app",
  messagingSenderId: "646061210319",
  appId: "1:646061210319:web:5208edb8a47a8c959d15ba"
};

const ALLOWED_EMAILS = ["c.jonesroberts@gmail.com", "lrobertsmlt@gmail.com"];
const ANTHROPIC_API = "https://api.anthropic.com/v1/messages";
const CATS = ["Dinner","Lunch","Breakfast","Snack","Dessert","Side"];

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const provider = new GoogleAuthProvider();

let state = {
  user: null, recipes: [], selected: null,
  view: "list", search: "", category: "All",
  successMsg: null, formError: null,
  editingId: null, form: emptyForm(),
  showChat: false, chatMessages: [], chatLoading: false,
  pendingRecipe: null
};

function emptyForm() {
  return { title:"", category:"Dinner", rating:5, favorite:false, cook_time:"",
    tags:"", date:todayStr(), notes:"",
    components:[{name:"", ingredients:[""], steps:[""]}] };
}
function todayStr() { return new Date().toISOString().split("T")[0]; }
function stars(n) { return "‚òÖ".repeat(n||0)+"‚òÜ".repeat(5-(n||0)); }
function esc(s) { return s==null?'':String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }

// ‚îÄ‚îÄ Auth ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function signIn() {
  try {
    const result = await signInWithPopup(auth, provider);
    const email = result.user.email;
    if (!ALLOWED_EMAILS.includes(email)) {
      await signOut(auth);
      document.getElementById("login-error").textContent = "Sorry, this app is private. Contact CJ for access.";
      return;
    }
  } catch(e) {
    document.getElementById("login-error").textContent = "Sign in failed: " + e.message;
  }
}

onAuthStateChanged(auth, async (user) => {
  if (user && ALLOWED_EMAILS.includes(user.email)) {
    state.user = user;
    await loadRecipes();
    render();
  } else {
    state.user = null;
    renderLogin();
  }
});

// ‚îÄ‚îÄ Firestore ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadRecipes() {
  try {
    const q = query(collection(db, "recipes"), orderBy("date", "desc"));
    const snap = await getDocs(q);
    state.recipes = snap.docs.map(d => ({ id: d.id, ...d.data() }));
  } catch(e) {
    // If index not ready yet, load without sort
    try {
      const snap = await getDocs(collection(db, "recipes"));
      state.recipes = snap.docs.map(d => ({ id: d.id, ...d.data() }));
    } catch(e2) { console.error(e2); }
  }
}

async function saveRecipe() {
  syncForm();
  const f = state.form;
  const payload = {
    title: f.title, category: f.category, rating: parseInt(f.rating)||5,
    favorite: f.favorite, cook_time: f.cook_time ? parseInt(f.cook_time) : null,
    tags: f.tags ? f.tags.split(",").map(t=>t.trim()).filter(Boolean) : [],
    date: f.date, notes: f.notes,
    components: f.components.map(c=>({
      name: c.name,
      ingredients: c.ingredients.filter(Boolean),
      steps: c.steps.filter(Boolean)
    })),
    createdBy: state.user.email,
    updatedAt: new Date().toISOString()
  };
  const btn = document.getElementById("save-btn");
  if(btn){btn.disabled=true;btn.textContent="Saving...";}
  try {
    if (state.editingId) {
      await updateDoc(doc(db, "recipes", state.editingId), payload);
      state.recipes = state.recipes.map(r => r.id===state.editingId ? {id:state.editingId,...payload} : r);
      state.selected = {id:state.editingId,...payload};
    } else {
      const ref = await addDoc(collection(db, "recipes"), payload);
      const newRecipe = {id:ref.id,...payload};
      state.recipes.unshift(newRecipe);
      state.selected = newRecipe;
    }
    state.view="detail"; state.successMsg="Recipe saved!";
    state.formError=null; state.editingId=null;
  } catch(e) {
    state.formError="Failed to save: "+e.message;
    if(btn){btn.disabled=false;btn.textContent="Save Recipe";}
  }
  render();
}

async function deleteRecipe(id) {
  if(!confirm("Delete this recipe?")) return;
  try {
    await deleteDoc(doc(db, "recipes", id));
    state.recipes = state.recipes.filter(r=>r.id!==id);
    state.selected=null; state.view="list";
  } catch(e) { alert("Delete failed: "+e.message); }
  render();
}

// ‚îÄ‚îÄ Claude Chat ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function sendChat(message) {
  state.chatMessages.push({role:"user", content:message});
  state.chatLoading = true;
  state.pendingRecipe = null;
  render();

  const systemPrompt = `You are a friendly cooking assistant for CJ and his wife. Help them come up with delicious recipes based on what they have or what they're in the mood for.

When suggesting a recipe, always format it as valid JSON at the end of your message inside a <recipe> tag, like this:
<recipe>
{
  "title": "Recipe Name",
  "category": "Dinner",
  "rating": 5,
  "favorite": false,
  "cook_time": 30,
  "tags": ["easy", "chicken"],
  "date": "${todayStr()}",
  "notes": "Any tips or observations",
  "components": [
    {
      "name": "Component Name",
      "ingredients": ["ingredient 1", "ingredient 2"],
      "steps": ["step 1", "step 2"]
    }
  ]
}
</recipe>

Keep the recipe JSON valid. Be warm, conversational, and enthusiastic about food. If they already have ingredients, use those. If they want something specific, deliver it with flair.`;

  try {
    const res = await fetch(ANTHROPIC_API, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        model: "claude-sonnet-4-20250514",
        max_tokens: 1000,
        system: systemPrompt,
        messages: state.chatMessages.map(m=>({role:m.role, content:m.content}))
      })
    });
    const data = await res.json();
    const text = data.content?.[0]?.text || "Sorry, I couldn't generate a response.";
    state.chatMessages.push({role:"assistant", content:text});

    // Extract recipe JSON if present
    const match = text.match(/<recipe>([\s\S]*?)<\/recipe>/);
    if (match) {
      try {
        state.pendingRecipe = JSON.parse(match[1].trim());
      } catch(e) { console.error("Recipe parse error", e); }
    }
  } catch(e) {
    state.chatMessages.push({role:"assistant", content:"Sorry, I had trouble connecting. Please try again."});
  }
  state.chatLoading = false;
  render();
  // Scroll chat to bottom
  setTimeout(()=>{
    const el = document.getElementById("chat-messages");
    if(el) el.scrollTop = el.scrollHeight;
  }, 50);
}

function loadRecipeFromChat() {
  if (!state.pendingRecipe) return;
  state.form = {
    title: state.pendingRecipe.title || "",
    category: state.pendingRecipe.category || "Dinner",
    rating: state.pendingRecipe.rating || 5,
    favorite: state.pendingRecipe.favorite || false,
    cook_time: state.pendingRecipe.cook_time || "",
    tags: (state.pendingRecipe.tags||[]).join(", "),
    date: state.pendingRecipe.date || todayStr(),
    notes: state.pendingRecipe.notes || "",
    components: (state.pendingRecipe.components||[]).map(c=>({
      name: c.name||"",
      ingredients: c.ingredients?.length ? c.ingredients : [""],
      steps: c.steps?.length ? c.steps : [""]
    }))
  };
  state.editingId = null;
  state.formError = null;
  state.successMsg = null;
  state.view = "form";
  render();
}

// ‚îÄ‚îÄ Form helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function startAdd() {
  state.form=emptyForm(); state.editingId=null;
  state.formError=null; state.successMsg=null; state.view="form"; render();
}
function startEdit(r) {
  state.form={
    title:r.title||"", category:r.category||"Dinner", rating:r.rating||5,
    favorite:r.favorite||false, cook_time:r.cook_time||"",
    tags:(r.tags||[]).join(", "), date:r.date||todayStr(), notes:r.notes||"",
    components:(r.components||[]).map(c=>({
      name:c.name||"",
      ingredients:c.ingredients?.length?[...c.ingredients]:[""],
      steps:c.steps?.length?[...c.steps]:[""]
    }))
  };
  state.editingId=r.id; state.formError=null; state.successMsg=null; state.view="form"; render();
}
function syncForm() {
  const g=id=>document.getElementById(id); const f=state.form;
  if(g("f-title")) f.title=g("f-title").value;
  if(g("f-cat")) f.category=g("f-cat").value;
  if(g("f-cooktime")) f.cook_time=g("f-cooktime").value;
  if(g("f-date")) f.date=g("f-date").value;
  if(g("f-tags")) f.tags=g("f-tags").value;
  if(g("f-notes")) f.notes=g("f-notes").value;
  if(g("f-fav")) f.favorite=g("f-fav").checked;
  document.querySelectorAll(".cn-input").forEach(el=>{const ci=+el.dataset.ci;if(f.components[ci])f.components[ci].name=el.value;});
  document.querySelectorAll(".ing-input").forEach(el=>{const ci=+el.dataset.ci,ii=+el.dataset.ii;if(f.components[ci])f.components[ci].ingredients[ii]=el.value;});
  document.querySelectorAll(".step-input").forEach(el=>{const ci=+el.dataset.ci,si=+el.dataset.si;if(f.components[ci])f.components[ci].steps[si]=el.value;});
}

// ‚îÄ‚îÄ Render ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderLogin() {
  document.getElementById("root").innerHTML=`
  <div class="login-screen">
    <div class="login-card">
      <div style="font-size:48px;margin-bottom:16px;">üçΩ</div>
      <h1>CMLB Recipes</h1>
      <p>CJ & Lauren's private recipe catalog</p>
      <button class="google-btn" id="google-signin-btn">
        <svg viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l3.66-2.84z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
        Sign in with Google
      </button>
      <div id="login-error" class="login-error"></div>
    </div>
  </div>`;
  document.getElementById("google-signin-btn").addEventListener("click", signIn);
}

function render() {
  if (!state.user) { renderLogin(); return; }
  const filtered = state.recipes.filter(r=>{
    const mc=state.category==="All"||r.category===state.category;
    const q=state.search.toLowerCase();
    const ms=!q||r.title.toLowerCase().includes(q)||(r.tags||[]).some(t=>t.toLowerCase().includes(q))||(r.notes||"").toLowerCase().includes(q);
    return mc&&ms;
  });

  document.getElementById("root").innerHTML=`
  <div class="app">
    <div class="sidebar">
      <div class="sidebar-header">
        <h1>üçΩ CMLB Recipes</h1>
        <div class="user-row">
          ${state.user.photoURL?`<img class="user-avatar" src="${esc(state.user.photoURL)}">`:''}
          <span class="user-name">${esc(state.user.displayName||state.user.email)}</span>
          <button class="signout-btn" id="signout-btn">Sign out</button>
        </div>
      </div>
      <button class="add-btn" id="add-btn">+ Add a Recipe</button>
      <button class="chat-btn" id="chat-btn">‚ú¶ Ask Claude for Ideas</button>
      <div class="search-wrap">
        <input id="search-input" type="text" placeholder="Search..." value="${esc(state.search)}">
      </div>
      <div class="filters">
        ${["All",...CATS].map(c=>`<button class="filter-btn${state.category===c?' active':''}" data-cat="${c}">${c}</button>`).join('')}
      </div>
      <div class="recipe-list">
        ${filtered.length===0?`<div style="padding:16px;color:var(--text-dim);font-style:italic;font-size:14px;">No recipes found.</div>`:''}
        ${filtered.map(r=>`
          <div class="recipe-item${state.selected?.id===r.id&&state.view==='detail'?' active':''}" data-id="${r.id}">
            <div class="recipe-item-title">${esc(r.title)}</div>
            <div class="recipe-item-meta">
              <span class="stars">${stars(r.rating)}</span>
              ${r.favorite?'<span class="fav-badge">‚ô•</span>':''}
              ${r.cook_time?`<span class="cook-time">‚è±${r.cook_time}m</span>`:''}
              ${(r.tags||[]).slice(0,2).map(t=>`<span class="tag">${esc(t)}</span>`).join('')}
            </div>
          </div>`).join('')}
      </div>
    </div>

    <div class="main">
      ${state.successMsg?`<div class="success-msg fade-in">‚úì ${esc(state.successMsg)}</div>`:''}
      ${state.view==='form'?renderForm():''}
      ${state.view==='detail'&&state.selected?renderDetail(state.selected):''}
      ${state.view==='list'?`<div class="empty-state"><div class="icon">üç≥</div><h2>Select a recipe to view it</h2><p>Or ask Claude for inspiration.</p></div>`:''}
    </div>

    ${state.showChat?renderChatPanel():''}
  </div>`;

  bindEvents();

  // Scroll chat to bottom after render
  const cm = document.getElementById("chat-messages");
  if(cm) cm.scrollTop = cm.scrollHeight;
}

function renderDetail(r) {
  const comps=Array.isArray(r.components)?r.components:(typeof r.components==='string'?JSON.parse(r.components):[]);
  return `<div class="fade-in">
    <div class="action-row">
      <button class="btn" id="edit-btn">‚úé Edit</button>
      <button class="btn btn-danger" id="del-btn">‚úï Delete</button>
    </div>
    <h1 class="recipe-title">${esc(r.title)}</h1>
    <div class="recipe-meta-row">
      <span class="big-stars">${stars(r.rating)}</span>
      ${r.category?`<span class="meta-pill category">${esc(r.category)}</span>`:''}
      ${r.cook_time?`<span class="meta-pill">‚è± ${r.cook_time} min</span>`:''}
      ${r.favorite?`<span class="meta-pill" style="color:var(--red);border-color:var(--red);">‚ô• Favorite</span>`:''}
      ${(r.tags||[]).map(t=>`<span class="meta-pill">${esc(t)}</span>`).join('')}
      ${r.date?`<span class="meta-pill" style="margin-left:auto;">${r.date}</span>`:''}
    </div>
    ${r.notes?`<div class="notes-block">${esc(r.notes)}</div>`:''}
    ${comps.map(c=>`
      <div class="component">
        <div class="component-title">${esc(c.name)}</div>
        <div class="component-grid">
          <div>
            <div class="col-label">Ingredients</div>
            ${(c.ingredients||[]).map(i=>`<div class="ingredient-item">${esc(i)}</div>`).join('')}
          </div>
          <div>
            <div class="col-label">Method</div>
            ${(c.steps||[]).map((s,i)=>`<div class="step-item"><span class="step-num">${i+1}.</span><span>${esc(s)}</span></div>`).join('')}
          </div>
        </div>
      </div>`).join('')}
  </div>`;
}

function renderForm() {
  const f=state.form;
  return `<div class="form-wrap fade-in">
    ${state.formError?`<div class="error-msg">‚ö† ${esc(state.formError)}</div>`:''}
    <h2 class="form-title">${state.editingId?'Edit Recipe':'Add a New Recipe'}</h2>
    <div class="form-group"><label>Recipe Title</label>
      <input id="f-title" class="form-control" value="${esc(f.title)}" placeholder="e.g. Honey Mustard Roasted Potatoes"></div>
    <div class="form-grid">
      <div class="form-group"><label>Category</label>
        <select id="f-cat" class="form-control">${CATS.map(c=>`<option${f.category===c?' selected':''}>${c}</option>`).join('')}</select></div>
      <div class="form-group"><label>Cook Time (minutes)</label>
        <input id="f-cooktime" class="form-control" type="number" value="${esc(String(f.cook_time))}" placeholder="35"></div>
    </div>
    <div class="form-grid">
      <div class="form-group"><label>Rating</label>
        <div class="star-select">${[1,2,3,4,5].map(n=>`<span class="star${n<=f.rating?' lit':''}" data-n="${n}">‚òÖ</span>`).join('')}</div></div>
      <div class="form-group"><label>Date</label>
        <input id="f-date" class="form-control" type="date" value="${esc(f.date)}"></div>
    </div>
    <div class="form-group"><label>Tags (comma separated)</label>
      <input id="f-tags" class="form-control" value="${esc(f.tags)}" placeholder="easy, sheet pan, chicken"></div>
    <div class="form-group">
      <label class="checkbox-row"><input type="checkbox" id="f-fav"${f.favorite?' checked':''}> <span style="font-size:15px;text-transform:none;letter-spacing:0;">Mark as Favorite ‚ô•</span></label></div>
    <div class="form-group"><label>Notes</label>
      <textarea id="f-notes" class="form-control" placeholder="Observations, tips, variations...">${esc(f.notes)}</textarea></div>
    <div style="margin:20px 0 8px;font-size:10px;letter-spacing:.15em;text-transform:uppercase;color:var(--text-muted);">Components</div>
    <div id="comp-list">
      ${f.components.map((c,ci)=>`
        <div class="comp-block">
          <div class="comp-block-header">
            <input class="cn-input" data-ci="${ci}" value="${esc(c.name)}" placeholder="Component name (e.g. Roasted Potatoes)">
            <button class="icon-btn rm-comp" data-ci="${ci}">‚úï</button>
          </div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px;">
            <div><div class="col-label">Ingredients</div>
              <div class="list-rows">${c.ingredients.map((ing,ii)=>`
                <div class="list-row"><input class="ing-input" data-ci="${ci}" data-ii="${ii}" value="${esc(ing)}" placeholder="Ingredient">
                <button class="icon-btn rm-ing" data-ci="${ci}" data-ii="${ii}">‚úï</button></div>`).join('')}</div>
              <button class="add-row-btn add-ing" data-ci="${ci}">+ ingredient</button></div>
            <div><div class="col-label">Steps</div>
              <div class="list-rows">${c.steps.map((s,si)=>`
                <div class="list-row"><input class="step-input" data-ci="${ci}" data-si="${si}" value="${esc(s)}" placeholder="Step ${si+1}">
                <button class="icon-btn rm-step" data-ci="${ci}" data-si="${si}">‚úï</button></div>`).join('')}</div>
              <button class="add-row-btn add-step" data-ci="${ci}">+ step</button></div>
          </div>
        </div>`).join('')}
    </div>
    <button class="add-comp-btn" id="add-comp">+ Add Component</button>
    <div class="form-actions">
      <button class="btn-save" id="save-btn">Save Recipe</button>
      <button class="btn-cancel" id="cancel-btn">Cancel</button>
    </div>
  </div>`;
}

function renderChatPanel() {
  const msgs = state.chatMessages;
  return `<div class="chat-panel">
    <div class="chat-header">
      <h3>‚ú¶ Claude's Kitchen</h3>
      <button class="close-chat-btn" id="close-chat">‚úï</button>
    </div>
    <div class="chat-messages" id="chat-messages">
      ${msgs.length===0?`<div class="chat-msg assistant">Hi! I'm Claude. Tell me what you're in the mood for, what ingredients you have, or ask me to suggest a recipe ‚Äî I'll come up with something delicious for you both. üçΩ</div>`:''}
      ${msgs.map(m=>`<div class="chat-msg ${m.role}">${esc(m.content.replace(/<recipe>[\s\S]*?<\/recipe>/g,'').trim())}</div>`).join('')}
      ${state.chatLoading?`<div class="chat-msg assistant thinking">Thinking...</div>`:''}
      ${state.pendingRecipe?`<button class="save-recipe-btn" id="load-recipe-btn">‚Üì Load "${esc(state.pendingRecipe.title)}" into form</button>`:''}
    </div>
    <div class="chat-input-row">
      <textarea class="chat-input" id="chat-input" placeholder="What are you in the mood for?" rows="1"></textarea>
      <button class="chat-send-btn" id="chat-send" ${state.chatLoading?'disabled':''}>‚û§</button>
    </div>
  </div>`;
}

function bindEvents() {
  const on=(sel,ev,fn)=>document.querySelectorAll(sel).forEach(el=>el.addEventListener(ev,fn));
  const g=id=>document.getElementById(id);

  g("signout-btn")?.addEventListener("click",()=>signOut(auth));
  g("search-input")?.addEventListener("input",e=>{state.search=e.target.value;render();});
  on(".filter-btn","click",e=>{state.category=e.currentTarget.dataset.cat;render();});
  on(".recipe-item","click",e=>{
    const r=state.recipes.find(r=>r.id===e.currentTarget.dataset.id);
    if(r){state.selected=r;state.view="detail";state.successMsg=null;render();}
  });
  g("add-btn")?.addEventListener("click",startAdd);
  g("chat-btn")?.addEventListener("click",()=>{state.showChat=!state.showChat;render();});
  g("close-chat")?.addEventListener("click",()=>{state.showChat=false;render();});
  g("edit-btn")?.addEventListener("click",()=>startEdit(state.selected));
  g("del-btn")?.addEventListener("click",()=>deleteRecipe(state.selected.id));
  on(".star","click",e=>{
    state.form.rating=+e.currentTarget.dataset.n;
    document.querySelectorAll(".star").forEach((s,i)=>s.classList.toggle("lit",i<state.form.rating));
  });
  g("add-comp")?.addEventListener("click",()=>{syncForm();state.form.components.push({name:"",ingredients:[""],steps:[""]});render();});
  on(".rm-comp","click",e=>{syncForm();state.form.components.splice(+e.currentTarget.dataset.ci,1);render();});
  on(".add-ing","click",e=>{syncForm();state.form.components[+e.currentTarget.dataset.ci].ingredients.push("");render();});
  on(".rm-ing","click",e=>{syncForm();const{ci,ii}=e.currentTarget.dataset;state.form.components[+ci].ingredients.splice(+ii,1);render();});
  on(".add-step","click",e=>{syncForm();state.form.components[+e.currentTarget.dataset.ci].steps.push("");render();});
  on(".rm-step","click",e=>{syncForm();const{ci,si}=e.currentTarget.dataset;state.form.components[+ci].steps.splice(+si,1);render();});
  g("save-btn")?.addEventListener("click",saveRecipe);
  g("cancel-btn")?.addEventListener("click",()=>{state.view=state.selected?"detail":"list";state.formError=null;render();});
  g("load-recipe-btn")?.addEventListener("click",loadRecipeFromChat);

  // Chat
  const chatInput = g("chat-input");
  const chatSend = g("chat-send");
  if(chatInput && chatSend) {
    chatSend.addEventListener("click",()=>{
      const msg=chatInput.value.trim();
      if(!msg||state.chatLoading) return;
      chatInput.value="";
      sendChat(msg);
    });
    chatInput.addEventListener("keydown",e=>{
      if(e.key==="Enter"&&!e.shiftKey){
        e.preventDefault();
        const msg=chatInput.value.trim();
        if(!msg||state.chatLoading) return;
        chatInput.value="";
        sendChat(msg);
      }
    });
  }
}
</script>
</body>
</html>
