<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Our Recipe Catalog</title>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,600;1,400&family=Crimson+Text:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #0f0c08;
      --surface: #1c1510;
      --surface2: #251c14;
      --border: #3a2a18;
      --gold: #c8860a;
      --gold-light: #f5dfa0;
      --text: #e8d5b0;
      --text-muted: #8a6940;
      --text-dim: #4a3520;
      --red: #c0392b;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: 'Crimson Text', Georgia, serif;
      font-size: 18px;
      min-height: 100vh;
    }

    /* Grain overlay */
    body::before {
      content: '';
      position: fixed;
      inset: 0;
      background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.04'/%3E%3C/svg%3E");
      pointer-events: none;
      z-index: 1000;
      opacity: 0.4;
    }

    /* Layout */
    .app { display: flex; height: 100vh; overflow: hidden; }

    /* Sidebar */
    .sidebar {
      width: 300px;
      flex-shrink: 0;
      background: var(--surface);
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .sidebar-header {
      padding: 28px 24px 20px;
      border-bottom: 1px solid var(--border);
    }

    .sidebar-header h1 {
      font-family: 'Playfair Display', Georgia, serif;
      font-size: 22px;
      font-weight: 400;
      font-style: italic;
      color: var(--gold-light);
      line-height: 1.2;
    }

    .sidebar-header .subtitle {
      font-size: 13px;
      color: var(--text-muted);
      margin-top: 4px;
      letter-spacing: 0.05em;
    }

    .search-wrap { padding: 16px 20px; border-bottom: 1px solid var(--border); }

    .search-wrap input {
      width: 100%;
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text);
      padding: 9px 12px;
      font-family: 'Crimson Text', serif;
      font-size: 16px;
      outline: none;
      transition: border-color 0.2s;
    }

    .search-wrap input:focus { border-color: var(--gold); }
    .search-wrap input::placeholder { color: var(--text-dim); }

    .filters { padding: 12px 20px; border-bottom: 1px solid var(--border); display: flex; flex-wrap: wrap; gap: 6px; }

    .filter-btn {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--text-muted);
      padding: 4px 12px;
      border-radius: 20px;
      font-family: 'Crimson Text', serif;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .filter-btn:hover { border-color: var(--gold); color: var(--gold); }
    .filter-btn.active { background: var(--gold); border-color: var(--gold); color: #0f0c08; font-weight: 600; }

    .recipe-list { flex: 1; overflow-y: auto; padding: 8px 0; }

    .recipe-list::-webkit-scrollbar { width: 4px; }
    .recipe-list::-webkit-scrollbar-track { background: transparent; }
    .recipe-list::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

    .recipe-item {
      padding: 14px 20px;
      cursor: pointer;
      border-left: 3px solid transparent;
      transition: all 0.15s;
      border-bottom: 1px solid var(--surface2);
    }

    .recipe-item:hover { background: var(--surface2); border-left-color: var(--border); }
    .recipe-item.active { background: var(--surface2); border-left-color: var(--gold); }

    .recipe-item-title {
      font-family: 'Playfair Display', serif;
      font-size: 15px;
      color: var(--gold-light);
      line-height: 1.3;
      margin-bottom: 5px;
    }

    .recipe-item-meta { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }

    .stars { color: var(--gold); font-size: 12px; letter-spacing: 1px; }

    .tag {
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 10px;
      background: var(--surface);
      color: var(--text-muted);
      border: 1px solid var(--border);
    }

    .fav-badge { color: var(--red); font-size: 13px; }

    .cook-time { font-size: 12px; color: var(--text-muted); }

    /* Main content */
    .main {
      flex: 1;
      overflow-y: auto;
      padding: 40px 48px;
    }

    .main::-webkit-scrollbar { width: 4px; }
    .main::-webkit-scrollbar-track { background: transparent; }
    .main::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

    .empty-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      color: var(--text-dim);
      text-align: center;
      gap: 16px;
    }

    .empty-state .icon { font-size: 56px; }
    .empty-state h2 { font-family: 'Playfair Display', serif; font-style: italic; font-weight: 400; font-size: 24px; color: var(--text-muted); }
    .empty-state p { font-size: 16px; }

    /* Recipe detail */
    .recipe-title {
      font-family: 'Playfair Display', serif;
      font-size: 34px;
      font-weight: 400;
      font-style: italic;
      color: var(--gold-light);
      line-height: 1.2;
      margin-bottom: 16px;
    }

    .recipe-meta-row {
      display: flex;
      align-items: center;
      gap: 16px;
      flex-wrap: wrap;
      margin-bottom: 24px;
      padding-bottom: 24px;
      border-bottom: 1px solid var(--border);
    }

    .meta-pill {
      background: var(--surface2);
      border: 1px solid var(--border);
      color: var(--text-muted);
      font-size: 13px;
      padding: 4px 14px;
      border-radius: 20px;
      letter-spacing: 0.05em;
    }

    .meta-pill.category { color: var(--gold); border-color: var(--gold); }

    .big-stars { color: var(--gold); font-size: 20px; letter-spacing: 2px; }

    .notes-block {
      background: var(--surface2);
      border-left: 3px solid var(--gold);
      padding: 14px 18px;
      border-radius: 0 8px 8px 0;
      margin-bottom: 32px;
      font-style: italic;
      color: var(--text-muted);
      font-size: 17px;
      line-height: 1.6;
    }

    .component {
      margin-bottom: 36px;
    }

    .component-title {
      font-family: 'Playfair Display', serif;
      font-size: 20px;
      font-weight: 600;
      color: var(--gold-light);
      margin-bottom: 16px;
      padding-bottom: 10px;
      border-bottom: 1px solid var(--border);
    }

    .component-grid {
      display: grid;
      grid-template-columns: 1fr 1.6fr;
      gap: 24px;
    }

    .col-label {
      font-size: 11px;
      letter-spacing: 0.15em;
      text-transform: uppercase;
      color: var(--text-muted);
      margin-bottom: 10px;
    }

    .ingredient-item {
      display: flex;
      align-items: baseline;
      gap: 10px;
      padding: 7px 0;
      border-bottom: 1px solid var(--surface2);
      font-size: 16px;
      color: var(--text);
    }

    .ingredient-item::before { content: '¬∑'; color: var(--gold); flex-shrink: 0; }

    .step-item {
      display: flex;
      gap: 12px;
      padding: 8px 0;
      border-bottom: 1px solid var(--surface2);
      font-size: 16px;
      color: var(--text-muted);
      line-height: 1.6;
    }

    .step-num {
      color: var(--gold);
      font-family: 'Playfair Display', serif;
      font-size: 18px;
      flex-shrink: 0;
      width: 20px;
    }

    /* Loading */
    .loading {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100vh;
      font-family: 'Playfair Display', serif;
      font-style: italic;
      font-size: 22px;
      color: var(--text-muted);
    }

    @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
    .fade-in { animation: fadeIn 0.3s ease forwards; }

    .error-msg {
      background: #2a0a08;
      border: 1px solid #6b1a14;
      color: #e07060;
      padding: 12px 16px;
      border-radius: 8px;
      font-size: 15px;
      margin-bottom: 20px;
    }
  </style>
</head>
<body>

<div id="root" class="loading">Loading your recipes...</div>

<script>
  const API = "https://recipe-api-ysbb.onrender.com";

  let state = {
    recipes: [],
    selected: null,
    search: "",
    category: "All",
    loading: true,
    error: null
  };

  const CATEGORIES = ["All", "Dinner", "Lunch", "Breakfast", "Snack", "Dessert", "Side"];

  async function fetchRecipes() {
    const start = Date.now();
    let wakeNoticeTimer = setTimeout(() => {
      const el = document.getElementById("wake-notice");
      if (el) el.style.opacity = "1";
    }, 4000);

    try {
      const res = await fetch(`${API}/recipes`);
      if (!res.ok) throw new Error(`API error: ${res.status}`);
      state.recipes = await res.json();
      state.loading = false;
    } catch (e) {
      state.error = e.message;
      state.loading = false;
    }
    clearTimeout(wakeNoticeTimer);
    render();
  }

  function stars(n) {
    return "‚òÖ".repeat(n) + "‚òÜ".repeat(5 - n);
  }

  function filteredRecipes() {
    return state.recipes.filter(r => {
      const matchCat = state.category === "All" || r.category === state.category;
      const q = state.search.toLowerCase();
      const matchSearch = !q ||
        r.title.toLowerCase().includes(q) ||
        (r.tags || []).some(t => t.toLowerCase().includes(q)) ||
        (r.notes || "").toLowerCase().includes(q);
      return matchCat && matchSearch;
    });
  }

  function render() {
    const root = document.getElementById("root");

    if (state.loading) {
      root.className = "loading";
      root.innerHTML = `
        <div style="text-align:center;">
          <div style="font-family:'Playfair Display',serif;font-style:italic;font-size:22px;color:var(--text-muted);margin-bottom:16px;">
            Loading your recipes...
          </div>
          <div id="wake-notice" style="opacity:0;transition:opacity 0.8s ease;font-size:15px;color:var(--text-dim);font-family:'Crimson Text',serif;">
            The server is waking up ‚Äî this can take up to 60 seconds on first load.<br>Hang tight...
          </div>
        </div>
      `;
      return;
    }

    root.className = "app";

    const filtered = filteredRecipes();
    const sel = state.selected;

    root.innerHTML = `
      <div class="sidebar">
        <div class="sidebar-header">
          <h1>üçΩ Our Recipe Catalog</h1>
          <div class="subtitle">${state.recipes.length} recipe${state.recipes.length !== 1 ? 's' : ''} saved</div>
        </div>
        <div class="search-wrap">
          <input id="search-input" type="text" placeholder="Search recipes, tags..." value="${escHtml(state.search)}">
        </div>
        <div class="filters">
          ${CATEGORIES.map(cat => `
            <button class="filter-btn ${state.category === cat ? 'active' : ''}" data-cat="${cat}">${cat}</button>
          `).join('')}
        </div>
        <div class="recipe-list">
          ${filtered.length === 0 ? `<div style="padding:20px;color:var(--text-dim);font-style:italic;font-size:15px;">No recipes found.</div>` : ''}
          ${filtered.map(r => `
            <div class="recipe-item ${sel && sel.id === r.id ? 'active' : ''}" data-id="${r.id}">
              <div class="recipe-item-title">${escHtml(r.title)}</div>
              <div class="recipe-item-meta">
                <span class="stars">${stars(r.rating || 0)}</span>
                ${r.favorite ? '<span class="fav-badge">‚ô•</span>' : ''}
                ${r.cook_time ? `<span class="cook-time">‚è± ${r.cook_time}m</span>` : ''}
                ${(r.tags || []).slice(0, 2).map(t => `<span class="tag">${escHtml(t)}</span>`).join('')}
              </div>
            </div>
          `).join('')}
        </div>
      </div>

      <div class="main">
        ${state.error ? `<div class="error-msg">‚ö† Could not connect to API: ${escHtml(state.error)}</div>` : ''}
        ${sel ? renderRecipe(sel) : renderEmpty()}
      </div>
    `;

    // Bind events
    document.getElementById("search-input").addEventListener("input", e => {
      state.search = e.target.value;
      render();
    });

    document.querySelectorAll(".filter-btn").forEach(btn => {
      btn.addEventListener("click", () => {
        state.category = btn.dataset.cat;
        render();
      });
    });

    document.querySelectorAll(".recipe-item").forEach(item => {
      item.addEventListener("click", () => {
        const found = state.recipes.find(r => r.id === item.dataset.id);
        state.selected = found || null;
        render();
      });
    });
  }

  function renderEmpty() {
    return `
      <div class="empty-state">
        <div class="icon">üç≥</div>
        <h2>Select a recipe to view it</h2>
        <p>Your catalog grows as you cook together.</p>
      </div>
    `;
  }

  function renderRecipe(r) {
    const components = Array.isArray(r.components)
      ? r.components
      : (typeof r.components === 'string' ? JSON.parse(r.components) : []);

    return `
      <div class="fade-in">
        <h1 class="recipe-title">${escHtml(r.title)}</h1>
        <div class="recipe-meta-row">
          <span class="big-stars">${stars(r.rating || 0)}</span>
          ${r.category ? `<span class="meta-pill category">${escHtml(r.category)}</span>` : ''}
          ${r.cook_time ? `<span class="meta-pill">‚è± ${r.cook_time} min</span>` : ''}
          ${r.favorite ? `<span class="meta-pill" style="color:var(--red);border-color:var(--red);">‚ô• Favorite</span>` : ''}
          ${(r.tags || []).map(t => `<span class="meta-pill">${escHtml(t)}</span>`).join('')}
          ${r.date ? `<span class="meta-pill" style="margin-left:auto;">${r.date}</span>` : ''}
        </div>

        ${r.notes ? `<div class="notes-block">${escHtml(r.notes)}</div>` : ''}

        ${components.map(comp => `
          <div class="component">
            <div class="component-title">${escHtml(comp.name)}</div>
            <div class="component-grid">
              <div>
                <div class="col-label">Ingredients</div>
                ${(comp.ingredients || []).map(ing => `
                  <div class="ingredient-item">${escHtml(ing)}</div>
                `).join('')}
              </div>
              <div>
                <div class="col-label">Method</div>
                ${(comp.steps || []).map((step, i) => `
                  <div class="step-item">
                    <span class="step-num">${i + 1}.</span>
                    <span>${escHtml(step)}</span>
                  </div>
                `).join('')}
              </div>
            </div>
          </div>
        `).join('')}
      </div>
    `;
  }

  function escHtml(str) {
    if (!str) return '';
    return String(str)
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;');
  }

  // Boot
  fetchRecipes();
</script>
</body>
</html>
